# ğŸ—ï¸ MEDFOCUS PhD - ARQUITETURA TÃ‰CNICA DETALHADA

**Data:** 23 de fevereiro de 2026  
**VersÃ£o:** 1.0  
**Status:** ProduÃ§Ã£o-ready

---

## ğŸ“‘ ÃNDICE

1. [VisÃ£o Geral da Arquitetura](#visÃ£o-geral-da-arquitetura)
2. [Arquitetura de Dados](#arquitetura-de-dados)
3. [Fluxo de IngestÃ£o de Dados](#fluxo-de-ingestÃ£o-de-dados)
4. [Arquitetura Backend](#arquitetura-backend)
5. [Arquitetura Frontend](#arquitetura-frontend)
6. [Arquitetura GCP](#arquitetura-gcp)
7. [Pipeline Med-Brain (IA)](#pipeline-med-brain-ia)
8. [Sistema de NotificaÃ§Ãµes](#sistema-de-notificaÃ§Ãµes)
9. [SeguranÃ§a e AutenticaÃ§Ã£o](#seguranÃ§a-e-autenticaÃ§Ã£o)
10. [Escalabilidade e Performance](#escalabilidade-e-performance)

---

## ğŸŒ VISÃƒO GERAL DA ARQUITETURA

### Diagrama High-Level

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           USUÃRIOS FINAIS                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  Estudantes  â”‚    â”‚   MÃ©dicos   â”‚    â”‚     PhDs    â”‚                â”‚
â”‚  â”‚   (Flash)    â”‚    â”‚  (CrÃ­tico)  â”‚    â”‚   (Tese)    â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚         â”‚                   â”‚                    â”‚                       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                             â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“ HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          FRONTEND LAYER                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    React 18 + TypeScript                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚  â”‚
â”‚  â”‚  â”‚  Vite 7    â”‚  â”‚ TailwindCSSâ”‚  â”‚  Radix UI  â”‚                â”‚  â”‚
â”‚  â”‚  â”‚  (Build)   â”‚  â”‚    (CSS)   â”‚  â”‚ (Components)â”‚                â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚         tRPC Client (Type-safe API Calls)                 â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“ tRPC (JSON-RPC)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          BACKEND LAYER (Cloud Run)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                Express + tRPC + TypeScript                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚                    tRPC Routers (12)                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ auth  â€¢ materials  â€¢ quizzes  â€¢ analytics  â€¢ etc       â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚  â”‚
â”‚  â”‚  â”‚  Middleware    â”‚    â”‚   Services     â”‚                      â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ auth        â”‚    â”‚  â€¢ database    â”‚                      â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ logger      â”‚    â”‚  â€¢ websocket   â”‚                      â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ errorHandlerâ”‚    â”‚  â€¢ llm         â”‚                      â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                                 â”‚
        â†“ SQL                                             â†“ WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SQLite/CloudSQL â”‚                         â”‚   Socket.IO Server    â”‚
â”‚   (Drizzle ORM)   â”‚                         â”‚   (Question Battles)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         GCP SERVICES LAYER                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    DATA INGESTION PIPELINE                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚
â”‚  â”‚  â”‚   PubMed CF     â”‚  â”‚   ANVISA/FDA CF â”‚  â”‚  Document AI CF  â”‚â”‚  â”‚
â”‚  â”‚  â”‚  (Python 3.11)  â”‚  â”‚  (Python 3.11)  â”‚  â”‚  (Python 3.11)   â”‚â”‚  â”‚
â”‚  â”‚  â”‚  â° Weekly      â”‚  â”‚   â° Daily      â”‚  â”‚   ğŸ”„ On-demand   â”‚â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚
â”‚  â”‚           â”‚                    â”‚                     â”‚          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚                    â”‚                     â”‚              â”‚
â”‚              â†“                    â†“                     â†“              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         BigQuery                                 â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚
â”‚  â”‚  â”‚ pubmed_studies  â”‚  â”‚ anvisa_fda_updatesâ”‚  â”‚medical_guidelinesâ”‚â”‚  â”‚
â”‚  â”‚  â”‚  (1TB+)         â”‚  â”‚   (50GB+)         â”‚  â”‚   (100GB+)      â”‚â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    VERTEX AI + GEMINI                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Embeddings (text-embedding-004)                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â†’ VetorizaÃ§Ã£o semÃ¢ntica de 50k+ estudos                  â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Gemini 2.5 Pro (Preview) - Med-Brain                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ RAG (Retrieval-Augmented Generation)                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ 3 nÃ­veis de resposta (Student/Doctor/PhD)              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ Zero-hallucination com fontes ANVISA/PubMed            â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    PARTNER API (Apigee)                          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  REST API (OpenAPI 3.0)                                    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ POST /v1/clinical-updates                               â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ POST /v1/patient-support                                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â€¢ GET /v1/analytics                                       â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   PUB/SUB (Notifications)                        â”‚  â”‚
â”‚  â”‚  â€¢ Novos estudos publicados                                     â”‚  â”‚
â”‚  â”‚  â€¢ Alertas ANVISA/FDA                                            â”‚  â”‚
â”‚  â”‚  â€¢ Updates de laboratÃ³rios                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          EXTERNAL SERVICES                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚   PubMed     â”‚    â”‚ ANVISA/FDA   â”‚    â”‚  DrugBank    â”‚             â”‚
â”‚  â”‚     API      â”‚    â”‚   Websites   â”‚    â”‚     API      â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ARQUITETURA DE DADOS

### Modelo de Dados (Drizzle ORM)

#### Tabelas Principais

```typescript
// Schema simplificado (server/drizzle/schema.ts)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// USERS & AUTH
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
users {
  id: serial PK
  email: varchar(255) UNIQUE
  name: varchar(100)
  role: enum('student', 'doctor', 'phd', 'professor')
  university_id: int FK â†’ universities.id
  subscription_tier: enum('free', 'student', 'pro', 'elite', 'team')
  created_at: timestamp
  updated_at: timestamp
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ACADEMIC CONTENT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
materials {
  id: serial PK
  title: varchar(255)
  type: enum('pdf', 'video', 'slide', 'text')
  content_url: varchar(500)
  author_id: int FK â†’ users.id
  specialty: varchar(50) // 'Cardiology', 'Neurology', etc
  validation_status: enum('pending', 'approved', 'rejected')
  reviewer_id: int FK â†’ users.id
  created_at: timestamp
}

quizzes {
  id: serial PK
  title: varchar(255)
  type: enum('enamed', 'revalida', 'custom')
  difficulty: enum('easy', 'medium', 'hard')
  specialty: varchar(50)
  questions: jsonb // Array de questÃµes
  created_by: int FK â†’ users.id
}

quiz_attempts {
  id: serial PK
  quiz_id: int FK â†’ quizzes.id
  user_id: int FK â†’ users.id
  score: int
  time_spent: int // segundos
  answers: jsonb // Respostas do usuÃ¡rio
  completed_at: timestamp
}

flashcards {
  id: serial PK
  front: text
  back: text
  category: varchar(50)
  user_id: int FK â†’ users.id
  spaced_repetition_interval: int // dias
  next_review_date: timestamp
  ease_factor: float // 1.3 - 2.5
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GAMIFICATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
achievements {
  id: serial PK
  user_id: int FK â†’ users.id
  badge_type: varchar(50) // 'first_quiz', 'study_streak_7', etc
  earned_at: timestamp
}

user_stats {
  user_id: int PK FK â†’ users.id
  total_xp: int
  current_level: int
  study_streak_days: int
  quizzes_completed: int
  battles_won: int
  updated_at: timestamp
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SOCIAL & COLLABORATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
classrooms {
  id: serial PK
  name: varchar(255)
  professor_id: int FK â†’ users.id
  university_id: int FK â†’ universities.id
  code: varchar(10) UNIQUE // CÃ³digo de acesso
  max_students: int
  created_at: timestamp
}

classroom_members {
  classroom_id: int FK â†’ classrooms.id
  user_id: int FK â†’ users.id
  role: enum('professor', 'student')
  joined_at: timestamp
  PRIMARY KEY (classroom_id, user_id)
}

discussions {
  id: serial PK
  classroom_id: int FK â†’ classrooms.id
  author_id: int FK â†’ users.id
  title: varchar(255)
  content: text
  upvotes: int
  created_at: timestamp
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// NOTIFICATIONS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
notifications {
  id: serial PK
  user_id: int FK â†’ users.id
  type: enum('new_material', 'quiz_available', 'battle_invite', 'anvisa_alert')
  title: varchar(255)
  content: text
  read: boolean DEFAULT false
  created_at: timestamp
}
```

---

### BigQuery Schemas (GCP)

#### Tabela: pubmed_studies

```sql
CREATE TABLE medfocus.pubmed_studies (
  pubmed_id STRING NOT NULL,
  title STRING NOT NULL,
  abstract STRING,
  authors ARRAY<STRING>,
  journal STRING,
  publication_date DATE,
  doi STRING,
  study_type STRING, -- 'RCT', 'Meta-analysis', 'Cohort', etc
  
  -- Dados brasileiros
  molecule STRING, -- 'Dapagliflozina', 'Metformina', etc
  therapeutic_class STRING, -- 'AntidiabÃ©tico', 'Anti-hipertensivo'
  
  -- Embeddings para RAG
  embedding ARRAY<FLOAT64>, -- 768 dimensions (text-embedding-004)
  
  -- Metadata
  ingestion_timestamp TIMESTAMP,
  last_updated TIMESTAMP
)
PARTITION BY DATE(publication_date)
CLUSTER BY molecule, therapeutic_class;
```

**Tamanho estimado:** 50.000 estudos Ã— 50 KB = ~2.5 GB  
**Custo armazenamento:** $0.020/GB/mÃªs = ~$0.05/mÃªs  
**Custo query:** $5/TB processado

---

#### Tabela: anvisa_fda_updates

```sql
CREATE TABLE medfocus.anvisa_fda_updates (
  update_id STRING NOT NULL,
  source STRING NOT NULL, -- 'ANVISA', 'FDA', 'CMED', 'CRM'
  update_type STRING, -- 'recall', 'safety_alert', 'price_change', 'new_approval'
  
  -- Droga afetada
  medication_id STRING,
  medication_name STRING,
  
  -- ConteÃºdo
  title STRING,
  description TEXT,
  severity STRING, -- 'critical', 'high', 'medium', 'low'
  
  -- Links
  source_url STRING,
  pdf_url STRING,
  
  -- Timestamps
  published_date DATE,
  ingestion_timestamp TIMESTAMP,
  
  -- Hash para detecÃ§Ã£o de mudanÃ§as
  content_hash STRING
)
PARTITION BY DATE(published_date)
CLUSTER BY source, update_type, medication_id;
```

**Tamanho estimado:** ~50 MB/mÃªs  
**Custo:** negligÃ­vel

---

#### Tabela: medical_guidelines

```sql
CREATE TABLE medfocus.medical_guidelines (
  guideline_id STRING NOT NULL,
  society STRING, -- 'SBC', 'SBPT', 'ESC', 'AHA'
  title STRING NOT NULL,
  year INT64,
  specialty STRING,
  
  -- ConteÃºdo extraÃ­do
  full_text TEXT,
  extracted_tables ARRAY<STRUCT<
    table_id STRING,
    title STRING,
    rows ARRAY<ARRAY<STRING>>
  >>,
  extracted_figures ARRAY<STRUCT<
    figure_id STRING,
    caption STRING,
    image_url STRING
  >>,
  
  -- ValidaÃ§Ã£o
  validation_status STRING, -- 'pending', 'approved', 'rejected'
  reviewed_by STRING, -- email do mÃ©dico
  review_date TIMESTAMP,
  
  -- PDF original
  pdf_url STRING,
  document_ai_job_id STRING,
  
  -- Embeddings
  embedding ARRAY<FLOAT64>,
  
  -- Timestamps
  created_at TIMESTAMP,
  updated_at TIMESTAMP
)
PARTITION BY year
CLUSTER BY specialty, society;
```

**Tamanho estimado:** 500 diretrizes Ã— 5 MB = ~2.5 GB  
**Custo:** ~$0.05/mÃªs

---

## ğŸ”„ FLUXO DE INGESTÃƒO DE DADOS

### Pipeline 1: PubMed Ingestion (Semanal)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLOUD SCHEDULER                                 â”‚
â”‚  Trigger: Toda segunda-feira 02:00 BRT                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“ HTTP POST
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CLOUD FUNCTION: pubmed-ingestion                      â”‚
â”‚  Runtime: Python 3.11 | Memory: 512 MB | Timeout: 540s           â”‚
â”‚                                                                    â”‚
â”‚  STEP 1: Carregar lista de drogas                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  drugs = [                                                â”‚   â”‚
â”‚  â”‚    "Dapagliflozina", "Metformina", "Losartana", ...      â”‚   â”‚
â”‚  â”‚  ] # 500 drogas mais prescritas no Brasil                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                    â”‚
â”‚  STEP 2: Buscar no PubMed (BioPython)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  for drug in drugs:                                       â”‚   â”‚
â”‚  â”‚    query = f'"{drug}" AND "Randomized Controlled Trial"' â”‚   â”‚
â”‚  â”‚    results = Entrez.esearch(db="pubmed",                 â”‚   â”‚
â”‚  â”‚                             term=query,                   â”‚   â”‚
â”‚  â”‚                             retmax=100)                   â”‚   â”‚
â”‚  â”‚    pmids = results['IdList']                              â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚    # Fetch detalhes                                       â”‚   â”‚
â”‚  â”‚    articles = Entrez.efetch(db="pubmed",                 â”‚   â”‚
â”‚  â”‚                             id=pmids,                     â”‚   â”‚
â”‚  â”‚                             rettype="xml")                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                    â”‚
â”‚  STEP 3: Gerar embeddings (Vertex AI)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  model = TextEmbeddingModel.from_pretrained(             â”‚   â”‚
â”‚  â”‚    "text-embedding-004"                                   â”‚   â”‚
â”‚  â”‚  )                                                         â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚  for article in articles:                                 â”‚   â”‚
â”‚  â”‚    text = f"{article.title}\n{article.abstract}"         â”‚   â”‚
â”‚  â”‚    embedding = model.get_embeddings([text])[0].values    â”‚   â”‚
â”‚  â”‚    article['embedding'] = embedding # 768 dims           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                    â”‚
â”‚  STEP 4: Inserir no BigQuery (Streaming)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  client = bigquery.Client()                               â”‚   â”‚
â”‚  â”‚  table_id = "medfocus.pubmed_studies"                     â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚  rows_to_insert = [                                       â”‚   â”‚
â”‚  â”‚    {                                                       â”‚   â”‚
â”‚  â”‚      "pubmed_id": article.pmid,                           â”‚   â”‚
â”‚  â”‚      "title": article.title,                              â”‚   â”‚
â”‚  â”‚      "embedding": article.embedding,                      â”‚   â”‚
â”‚  â”‚      ...                                                   â”‚   â”‚
â”‚  â”‚    }                                                       â”‚   â”‚
â”‚  â”‚    for article in articles                                â”‚   â”‚
â”‚  â”‚  ]                                                         â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚  errors = client.insert_rows_json(table_id,              â”‚   â”‚
â”‚  â”‚                                    rows_to_insert)        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                    â”‚
â”‚  STEP 5: Notificar via Pub/Sub                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  publisher = pubsub_v1.PublisherClient()                  â”‚   â”‚
â”‚  â”‚  topic_path = "projects/medfocus/topics/new-studies"     â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚  message = {                                               â”‚   â”‚
â”‚  â”‚    "type": "pubmed_ingestion_completed",                  â”‚   â”‚
â”‚  â”‚    "count": len(articles),                                â”‚   â”‚
â”‚  â”‚    "timestamp": datetime.now().isoformat()                â”‚   â”‚
â”‚  â”‚  }                                                         â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚  publisher.publish(topic_path, json.dumps(message))      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         BIGQUERY                                   â”‚
â”‚  Table: pubmed_studies                                            â”‚
â”‚  New rows: ~50.000 (500 drugs Ã— 100 studies/drug)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Tempo de execuÃ§Ã£o:** ~9 minutos  
**Custo por execuÃ§Ã£o:** ~$0.15 (Cloud Function + Vertex AI embeddings)  
**FrequÃªncia:** Semanal  
**Custo mensal:** ~$0.60

---

### Pipeline 2: ANVISA/FDA Ingestion (DiÃ¡ria)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLOUD SCHEDULER                                 â”‚
â”‚  Trigger: Diariamente 08:00 BRT                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“ HTTP POST
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           CLOUD FUNCTION: anvisa-fda-ingestion                     â”‚
â”‚  Runtime: Python 3.11 | Memory: 256 MB | Timeout: 300s           â”‚
â”‚                                                                    â”‚
â”‚  STEP 1: Scraping de 4 fontes                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  sources = [                                              â”‚   â”‚
â”‚  â”‚    "https://www.gov.br/anvisa/pt-br/assuntos/           â”‚   â”‚
â”‚  â”‚     medicamentos/alertas-de-seguranca",                  â”‚   â”‚
â”‚  â”‚    "https://www.fda.gov/drugs/drug-safety-and-          â”‚   â”‚
â”‚  â”‚     availability/drug-safety-communications",            â”‚   â”‚
â”‚  â”‚    "https://www.gov.br/anvisa/pt-br/assuntos/           â”‚   â”‚
â”‚  â”‚     regulados/medicamentos/cmed",                        â”‚   â”‚
â”‚  â”‚    "https://portal.cfm.org.br/consulta-medico"           â”‚   â”‚
â”‚  â”‚  ]                                                         â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚  for url in sources:                                      â”‚   â”‚
â”‚  â”‚    html = requests.get(url).text                         â”‚   â”‚
â”‚  â”‚    soup = BeautifulSoup(html, 'html.parser')            â”‚   â”‚
â”‚  â”‚    entries = parse_source(soup, source=url)             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                    â”‚
â”‚  STEP 2: DetecÃ§Ã£o de mudanÃ§as (SHA-256 hash)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  for entry in entries:                                    â”‚   â”‚
â”‚  â”‚    content_hash = hashlib.sha256(                        â”‚   â”‚
â”‚  â”‚      entry['content'].encode()                           â”‚   â”‚
â”‚  â”‚    ).hexdigest()                                          â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚    # Verificar se jÃ¡ existe no BigQuery                  â”‚   â”‚
â”‚  â”‚    query = f"""                                           â”‚   â”‚
â”‚  â”‚      SELECT content_hash                                  â”‚   â”‚
â”‚  â”‚      FROM medfocus.anvisa_fda_updates                    â”‚   â”‚
â”‚  â”‚      WHERE update_id = '{entry['id']}'                   â”‚   â”‚
â”‚  â”‚    """                                                     â”‚   â”‚
â”‚  â”‚    existing = bq_client.query(query).result()            â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚    if not existing or existing[0] != content_hash:       â”‚   â”‚
â”‚  â”‚      new_entries.append(entry)  # Ã‰ novo ou mudou        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                    â”‚
â”‚  STEP 3: Inserir deltas no BigQuery                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  bq_client.insert_rows_json(                              â”‚   â”‚
â”‚  â”‚    "medfocus.anvisa_fda_updates",                         â”‚   â”‚
â”‚  â”‚    new_entries                                             â”‚   â”‚
â”‚  â”‚  )                                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                    â”‚
â”‚  STEP 4: Notificar usuÃ¡rios inscritos                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  # Para cada alerta crÃ­tico                               â”‚   â”‚
â”‚  â”‚  if entry['severity'] == 'critical':                      â”‚   â”‚
â”‚  â”‚    # Buscar mÃ©dicos inscritos na droga X                 â”‚   â”‚
â”‚  â”‚    query = f"""                                           â”‚   â”‚
â”‚  â”‚      SELECT user_id FROM user_subscriptions              â”‚   â”‚
â”‚  â”‚      WHERE medication_id = '{entry['medication_id']}'    â”‚   â”‚
â”‚  â”‚    """                                                     â”‚   â”‚
â”‚  â”‚    subscribers = bq_client.query(query).result()         â”‚   â”‚
â”‚  â”‚                                                            â”‚   â”‚
â”‚  â”‚    for user_id in subscribers:                            â”‚   â”‚
â”‚  â”‚      # Enviar via Pub/Sub â†’ Backend â†’ Push notification â”‚   â”‚
â”‚  â”‚      publisher.publish(                                   â”‚   â”‚
â”‚  â”‚        "medfocus/user-notifications",                     â”‚   â”‚
â”‚  â”‚        data={                                              â”‚   â”‚
â”‚  â”‚          "user_id": user_id,                              â”‚   â”‚
â”‚  â”‚          "type": "anvisa_alert",                          â”‚   â”‚
â”‚  â”‚          "title": entry['title'],                         â”‚   â”‚
â”‚  â”‚          "content": entry['description']                  â”‚   â”‚
â”‚  â”‚        }                                                   â”‚   â”‚
â”‚  â”‚      )                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         BIGQUERY                                   â”‚
â”‚  Table: anvisa_fda_updates                                        â”‚
â”‚  New rows: ~50-100/dia                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Tempo de execuÃ§Ã£o:** ~2 minutos  
**Custo por execuÃ§Ã£o:** ~$0.02  
**FrequÃªncia:** DiÃ¡ria  
**Custo mensal:** ~$0.60

---

## ğŸ–¥ï¸ ARQUITETURA BACKEND

### Stack Backend

```
Express.js (v4.18)
    â†“
tRPC (v11.6)  â†’  Type-safe API
    â†“
Drizzle ORM (v0.30)  â†’  SQLite/Cloud SQL
    â†“
Socket.IO (v4.6)  â†’  WebSocket para battles
```

### Estrutura de Routers (tRPC)

```typescript
// server/routers.ts

import { router } from './core/trpc';
import { authRouter } from './routes/auth';
import { materialsRouter } from './routes/materials';
import { quizzesRouter } from './routes/quizzes';
// ... mais imports

export const appRouter = router({
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // AUTENTICAÃ‡ÃƒO (OAuth + JWT)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  auth: authRouter,
  // Procedures:
  //   â€¢ register(email, password, role)
  //   â€¢ login(email, password) â†’ JWT token
  //   â€¢ logout()
  //   â€¢ refreshToken(refresh_token) â†’ new JWT
  //   â€¢ googleOAuth(code) â†’ JWT token
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // MATERIAIS ACADÃŠMICOS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  materials: materialsRouter,
  // Procedures:
  //   â€¢ list(filters) â†’ Material[]
  //   â€¢ get(id) â†’ Material
  //   â€¢ create(data) â†’ Material (auth required, role: professor+)
  //   â€¢ update(id, data) â†’ Material (auth required)
  //   â€¢ delete(id) â†’ void (auth required)
  //   â€¢ validate(id, status) â†’ Material (auth required, role: professor+)
  //   â€¢ upload(file) â†’ string (upload URL)
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // QUIZZES & SIMULADOS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  quizzes: quizzesRouter,
  // Procedures:
  //   â€¢ list(type, specialty) â†’ Quiz[]
  //   â€¢ get(id) â†’ Quiz (com questÃµes)
  //   â€¢ attempt(quiz_id, answers) â†’ QuizResult
  //   â€¢ history() â†’ QuizAttempt[] (auth required)
  //   â€¢ leaderboard(quiz_id) â†’ LeaderboardEntry[]
  //   â€¢ generateCustom(specialty, difficulty, count) â†’ Quiz (IA)
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ANALYTICS & PROGRESSO
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  analytics: analyticsRouter,
  // Procedures:
  //   â€¢ getUserStats(user_id) â†’ UserStats
  //   â€¢ getStudyHeatmap(user_id, year) â†’ HeatmapData
  //   â€¢ getProgressChart(user_id, period) â†’ ChartData
  //   â€¢ getWeakAreas(user_id) â†’ Specialty[]
  //   â€¢ compareWithPeers(user_id) â†’ ComparisonData
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SALAS DE AULA & TURMAS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  classrooms: classroomsRouter,
  // Procedures:
  //   â€¢ list() â†’ Classroom[] (professor: minhas turmas)
  //   â€¢ get(id) â†’ Classroom (com membros)
  //   â€¢ create(name, max_students) â†’ Classroom (professor only)
  //   â€¢ join(code) â†’ void (student)
  //   â€¢ leave(classroom_id) â†’ void
  //   â€¢ getMembers(classroom_id) â†’ User[]
  //   â€¢ getAnalytics(classroom_id) â†’ ClassroomAnalytics (professor)
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // DISCUSSÃ•ES & FÃ“RUM
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  discussions: discussionsRouter,
  // Procedures:
  //   â€¢ list(classroom_id, filters) â†’ Discussion[]
  //   â€¢ get(id) â†’ Discussion (com comments)
  //   â€¢ create(classroom_id, title, content) â†’ Discussion
  //   â€¢ comment(discussion_id, content) â†’ Comment
  //   â€¢ upvote(discussion_id) â†’ void
  //   â€¢ markAsAnswer(comment_id) â†’ void (professor)
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // NOTIFICAÃ‡Ã•ES
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notifications: notificationsRouter,
  // Procedures:
  //   â€¢ list() â†’ Notification[] (auth required)
  //   â€¢ markAsRead(id) â†’ void
  //   â€¢ markAllAsRead() â†’ void
  //   â€¢ subscribe(type, filters) â†’ void (ex: alertas ANVISA)
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SCRAPING & EXTERNAL DATA
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  scraping: scrapingRouter,
  // Procedures:
  //   â€¢ fetchDrugPrice(medication_name) â†’ PriceData
  //   â€¢ fetchAnvisaAlerts(medication_id) â†’ Alert[]
  //   â€¢ fetchPubMedStudies(query) â†’ Study[]
  
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // VALIDAÃ‡ÃƒO DE CONTEÃšDO
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  validation: validationRouter,
  // Procedures:
  //   â€¢ getPendingMaterials() â†’ Material[] (professor only)
  //   â€¢ getPendingGuidelines() â†’ Guideline[] (professor only)
  //   â€¢ approveMaterial(id, comments) â†’ void
  //   â€¢ rejectMaterial(id, reason) â†’ void
  //   â€¢ approveGuideline(id) â†’ void
});

export type AppRouter = typeof appRouter;
```

---

### Middleware Stack

```typescript
// server/_core/index.ts

import express from 'express';
import cors from 'cors';
import helmet from 'helmet';
import compression from 'compression';
import { createExpressMiddleware } from '@trpc/server/adapters/express';

const app = express();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SECURITY MIDDLEWARE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'", "'unsafe-inline'", "https://apis.google.com"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      imgSrc: ["'self'", "data:", "https:"],
      connectSrc: ["'self'", "https://generativelanguage.googleapis.com"]
    }
  }
}));

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CORS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.use(cors({
  origin: process.env.FRONTEND_URL || 'http://localhost:5173',
  credentials: true
}));

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// COMPRESSION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.use(compression());

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BODY PARSING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true }));

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOGGING (Custom)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import { logger } from './middleware/logger';
app.use(logger);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// tRPC ENDPOINT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import { appRouter } from '../routers';
import { createContext } from './context';

app.use('/api/trpc',
  createExpressMiddleware({
    router: appRouter,
    createContext,
    onError: ({ path, error }) => {
      console.error(`âŒ tRPC Error on ${path}:`, error);
    }
  })
);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WEBSOCKET (Socket.IO)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import { createServer } from 'http';
import { Server } from 'socket.io';
import { initBattleWs } from '../battleWs';

const httpServer = createServer(app);
const io = new Server(httpServer, {
  cors: {
    origin: process.env.FRONTEND_URL || 'http://localhost:5173',
    credentials: true
  }
});

initBattleWs(io); // Inicializar Question Battles

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HEALTH CHECK
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
app.get('/health', (req, res) => {
  res.json({
    status: 'ok',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    memory: process.memoryUsage(),
    version: process.env.npm_package_version
  });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ERROR HANDLER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import { errorHandler } from './middleware/errorHandler';
app.use(errorHandler);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// START SERVER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PORT = process.env.PORT || 8080; // Cloud Run usa 8080
httpServer.listen(PORT, () => {
  console.log(`âœ… Backend rodando na porta ${PORT}`);
  console.log(`ğŸ”— tRPC endpoint: http://localhost:${PORT}/api/trpc`);
  console.log(`ğŸ”Œ WebSocket: ws://localhost:${PORT}/ws`);
});
```

---

## ğŸ¨ ARQUITETURA FRONTEND

### Stack Frontend

```
React 18.2
    â†“
Vite 7.3 (Build tool)
    â†“
TypeScript 5.3 (Type safety)
    â†“
TailwindCSS 4.0 (Styling)
    â†“
Radix UI (52 components)
    â†“
TanStack Query (Cache & sync)
    â†“
tRPC Client (Type-safe API)
```

### Estrutura de Componentes

```
App.tsx (Root)
    â†“
    â”œâ”€â”€ ErrorBoundary
    â”‚       â†“
    â”‚       â””â”€â”€ [Captura erros globais]
    â”‚
    â”œâ”€â”€ ThemeProvider (Context API)
    â”‚       â†“
    â”‚       â””â”€â”€ [Modo claro/escuro]
    â”‚
    â”œâ”€â”€ Router (React Router v6)
    â”‚       â†“
    â”‚       â”œâ”€â”€ /login â†’ Login.tsx
    â”‚       â”œâ”€â”€ /signup â†’ Signup.tsx
    â”‚       â”œâ”€â”€ / â†’ DashboardLayout
    â”‚       â”‚       â†“
    â”‚       â”‚       â”œâ”€â”€ Sidebar.tsx
    â”‚       â”‚       â”œâ”€â”€ Header.tsx
    â”‚       â”‚       â””â”€â”€ Outlet:
    â”‚       â”‚               â”œâ”€â”€ /dashboard â†’ Dashboard.tsx
    â”‚       â”‚               â”œâ”€â”€ /materials â†’ AcademicLibrary.tsx
    â”‚       â”‚               â”œâ”€â”€ /quizzes â†’ SimuladoENAMED.tsx
    â”‚       â”‚               â”œâ”€â”€ /flashcards â†’ FlashcardStudy.tsx
    â”‚       â”‚               â”œâ”€â”€ /battles â†’ QuestionBattle.tsx
    â”‚       â”‚               â”œâ”€â”€ /classrooms â†’ ClassroomPanel.tsx
    â”‚       â”‚               â”œâ”€â”€ /analytics â†’ ProgressDashboard.tsx
    â”‚       â”‚               â””â”€â”€ /assistant â†’ Assistant.tsx
    â”‚       â”‚
    â”‚       â””â”€â”€ /404 â†’ NotFound.tsx
    â”‚
    â””â”€â”€ GlobalModals
            â†“
            â”œâ”€â”€ AIChatBox (floating)
            â”œâ”€â”€ XPToast (gamification)
            â””â”€â”€ NotificationBell
```

---

### tRPC Client Setup

```typescript
// client/src/lib/trpc.ts

import { createTRPCReact } from '@trpc/react-query';
import { httpBatchLink } from '@trpc/client';
import type { AppRouter } from '../../../server/routers';

export const trpc = createTRPCReact<AppRouter>();

// Provider no main.tsx
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { useState } from 'react';

function App() {
  const [queryClient] = useState(() => new QueryClient({
    defaultOptions: {
      queries: {
        staleTime: 60 * 1000, // 1 minuto
        refetchOnWindowFocus: false
      }
    }
  }));

  const [trpcClient] = useState(() =>
    trpc.createClient({
      links: [
        httpBatchLink({
          url: import.meta.env.VITE_API_URL + '/api/trpc',
          headers: () => {
            const token = localStorage.getItem('jwt_token');
            return token ? { Authorization: `Bearer ${token}` } : {};
          }
        })
      ]
    })
  );

  return (
    <trpc.Provider client={trpcClient} queryClient={queryClient}>
      <QueryClientProvider client={queryClient}>
        <YourApp />
      </QueryClientProvider>
    </trpc.Provider>
  );
}
```

---

### Exemplo de Uso (Type-safe)

```typescript
// client/src/components/medfocus/Dashboard.tsx

import { trpc } from '@/lib/trpc';

export function Dashboard() {
  // âœ… Totalmente type-safe! Auto-complete + type checking
  const { data: userStats, isLoading } = trpc.analytics.getUserStats.useQuery({
    user_id: userId
  });

  const { data: quizzes } = trpc.quizzes.list.useQuery({
    type: 'enamed',
    specialty: 'Cardiology'
  });

  // Mutation com invalidaÃ§Ã£o automÃ¡tica
  const attemptQuiz = trpc.quizzes.attempt.useMutation({
    onSuccess: () => {
      // Invalida cache e re-fetch
      trpc.useContext().analytics.getUserStats.invalidate();
    }
  });

  const handleSubmitQuiz = (answers: Answer[]) => {
    attemptQuiz.mutate({
      quiz_id: currentQuizId,
      answers
    });
  };

  if (isLoading) return <DashboardLayoutSkeleton />;

  return (
    <div className="grid grid-cols-12 gap-6 p-6">
      {/* Stats Cards */}
      <Card className="col-span-3">
        <CardHeader>
          <CardTitle>Total XP</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-3xl font-bold">{userStats?.total_xp}</p>
        </CardContent>
      </Card>

      {/* ... mais componentes */}
    </div>
  );
}
```

---

## â˜ï¸ ARQUITETURA GCP

### ServiÃ§os Utilizados

| ServiÃ§o | FunÃ§Ã£o | ConfiguraÃ§Ã£o |
|---------|--------|--------------|
| **Cloud Run** | Backend containerizado | 512 MB RAM, 1 vCPU, auto-scaling 1-10 |
| **Cloud Functions** | Data ingestion (3 functions) | Python 3.11, 256-512 MB |
| **BigQuery** | Data warehouse | 3 tabelas, 1TB+ armazenado |
| **Vertex AI** | Embeddings + Gemini | text-embedding-004 + Gemini 2.5 Pro |
| **Document AI** | ExtraÃ§Ã£o de PDFs | Healthcare Model |
| **Cloud Storage** | PDFs, uploads | Standard tier, ~500 GB |
| **Firestore** | Real-time data | Native mode |
| **Pub/Sub** | Event streaming | 2 topics |
| **Cloud Scheduler** | Cron jobs | 2 jobs (PubMed weekly, ANVISA daily) |
| **Apigee** | Partner API Gateway | Standard tier |
| **Cloud Logging** | Logs centralizados | 50 GB/mÃªs |
| **Cloud Monitoring** | MÃ©tricas e alertas | PadrÃ£o |

---

### Diagrama de Rede

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         INTERNET                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“ HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CLOUD LOAD BALANCER                         â”‚
â”‚  â€¢ SSL Termination (auto-managed cert)                          â”‚
â”‚  â€¢ DDoS protection                                               â”‚
â”‚  â€¢ CDN (Cloud CDN) para assets estÃ¡ticos                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                         â”‚
                    â†“ Backend                 â†“ Frontend
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   CLOUD RUN           â”‚   â”‚   VERCEL/CDN         â”‚
        â”‚  (Backend Express)    â”‚   â”‚   (Static React)     â”‚
        â”‚  â€¢ Port 8080          â”‚   â”‚   â€¢ Edge Network     â”‚
        â”‚  â€¢ Auto-scaling       â”‚   â”‚   â€¢ Serverless       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚            â”‚
                â†“ SQL        â†“ BigQuery
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  CLOUD SQL     â”‚  â”‚    BIGQUERY        â”‚
    â”‚  (PostgreSQL)  â”‚  â”‚  â€¢ pubmed_studies  â”‚
    â”‚  â€¢ SQLite â†’    â”‚  â”‚  â€¢ anvisa_fda_...  â”‚
    â”‚    migration   â”‚  â”‚  â€¢ guidelines      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â†“ Vertex AI
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         VERTEX AI                  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚  Text Embeddings (768d)      â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚  Gemini 2.5 Pro (Med-Brain)  â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§  PIPELINE MED-BRAIN (IA)

### Fluxo RAG (Retrieval-Augmented Generation)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER QUERY                                â”‚
â”‚  "Qual a dose de Dapagliflozina para paciente de 70kg com IC?"  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STEP 1: Embedding da Query                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  model = vertex_ai.TextEmbeddingModel("text-embedding-004") â”‚ â”‚
â”‚  â”‚  query_embedding = model.get_embeddings([query])[0].values  â”‚ â”‚
â”‚  â”‚  # Output: array de 768 floats                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        STEP 2: Busca SemÃ¢ntica no BigQuery                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  SELECT                                                      â”‚ â”‚
â”‚  â”‚    pubmed_id,                                                â”‚ â”‚
â”‚  â”‚    title,                                                    â”‚ â”‚
â”‚  â”‚    abstract,                                                 â”‚ â”‚
â”‚  â”‚    journal,                                                  â”‚ â”‚
â”‚  â”‚    publication_date,                                         â”‚ â”‚
â”‚  â”‚    -- DistÃ¢ncia de cosseno (similaridade)                   â”‚ â”‚
â”‚  â”‚    ML.DISTANCE(                                              â”‚ â”‚
â”‚  â”‚      embedding,                                              â”‚ â”‚
â”‚  â”‚      [0.123, 0.456, ...]  -- query_embedding                â”‚ â”‚
â”‚  â”‚    ) AS distance                                             â”‚ â”‚
â”‚  â”‚  FROM `medfocus.pubmed_studies`                              â”‚ â”‚
â”‚  â”‚  WHERE molecule = 'Dapagliflozina'                           â”‚ â”‚
â”‚  â”‚  ORDER BY distance ASC                                       â”‚ â”‚
â”‚  â”‚  LIMIT 10;  -- Top 10 mais relevantes                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚  Output: Top 10 estudos mais relevantes                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  [                                                           â”‚ â”‚
â”‚  â”‚    {                                                         â”‚ â”‚
â”‚  â”‚      "pubmed_id": "31535829",                                â”‚ â”‚
â”‚  â”‚      "title": "Dapagliflozin in Patients with Heart         â”‚ â”‚
â”‚  â”‚                 Failure and Reduced Ejection Fraction",      â”‚ â”‚
â”‚  â”‚      "abstract": "BACKGROUND: Sodium-glucose cotransporter  â”‚ â”‚
â”‚  â”‚                   2 inhibitors reduce the risk of           â”‚ â”‚
â”‚  â”‚                   hospitalization for heart failure...",     â”‚ â”‚
â”‚  â”‚      "journal": "N Engl J Med",                              â”‚ â”‚
â”‚  â”‚      "date": "2019-11-21",                                   â”‚ â”‚
â”‚  â”‚      "distance": 0.12  // Muito relevante                   â”‚ â”‚
â”‚  â”‚    },                                                         â”‚ â”‚
â”‚  â”‚    ... mais 9 estudos                                        â”‚ â”‚
â”‚  â”‚  ]                                                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         STEP 3: Buscar Diretrizes (Guidelines)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  SELECT title, extracted_tables, full_text                  â”‚ â”‚
â”‚  â”‚  FROM `medfocus.medical_guidelines`                          â”‚ â”‚
â”‚  â”‚  WHERE specialty = 'Cardiology'                              â”‚ â”‚
â”‚  â”‚    AND title LIKE '%Heart Failure%'                          â”‚ â”‚
â”‚  â”‚    AND validation_status = 'approved'                        â”‚ â”‚
â”‚  â”‚  ORDER BY year DESC                                          â”‚ â”‚
â”‚  â”‚  LIMIT 3;                                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚  Output: 3 diretrizes mais recentes                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  [                                                           â”‚ â”‚
â”‚  â”‚    {                                                         â”‚ â”‚
â”‚  â”‚      "title": "Diretriz Brasileira de InsuficiÃªncia        â”‚ â”‚
â”‚  â”‚                CardÃ­aca CrÃ´nica e Aguda - SBC 2024",        â”‚ â”‚
â”‚  â”‚      "extracted_tables": [                                   â”‚ â”‚
â”‚  â”‚        {                                                     â”‚ â”‚
â”‚  â”‚          "table_id": "tab3",                                 â”‚ â”‚
â”‚  â”‚          "title": "Doses de iSGLT2 em IC",                  â”‚ â”‚
â”‚  â”‚          "rows": [                                           â”‚ â”‚
â”‚  â”‚            ["Droga", "Dose Inicial", "Dose Alvo"],          â”‚ â”‚
â”‚  â”‚            ["Dapagliflozina", "10mg 1x/dia", "10mg 1x/dia"] â”‚ â”‚
â”‚  â”‚          ]                                                    â”‚ â”‚
â”‚  â”‚        }                                                      â”‚ â”‚
â”‚  â”‚      ]                                                        â”‚ â”‚
â”‚  â”‚    }                                                          â”‚ â”‚
â”‚  â”‚  ]                                                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         STEP 4: Construir Contexto RAG                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  context = f"""                                              â”‚ â”‚
â”‚  â”‚  # EVIDÃŠNCIAS CIENTÃFICAS (PubMed)                          â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  [PMID: 31535829] Dapagliflozin in Patients with HF...      â”‚ â”‚
â”‚  â”‚  - Abstract: BACKGROUND: Sodium-glucose cotransporter 2     â”‚ â”‚
â”‚  â”‚    inhibitors reduce the risk...                             â”‚ â”‚
â”‚  â”‚  - Journal: N Engl J Med (2019)                              â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  [PMID: 32970396] Cardiovascular and Renal Outcomes...      â”‚ â”‚
â”‚  â”‚  - Abstract: BACKGROUND: The DAPA-CKD trial showed...       â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  # DIRETRIZES BRASILEIRAS (SBC)                              â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  Diretriz SBC 2024 - InsuficiÃªncia CardÃ­aca:                â”‚ â”‚
â”‚  â”‚  Tabela 3 - Doses de iSGLT2:                                 â”‚ â”‚
â”‚  â”‚    Dapagliflozina: 10mg 1x/dia (dose Ãºnica)                 â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  # INFORMAÃ‡Ã•ES ANVISA                                        â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  Bula Dapagliflozina (ForxigaÂ®):                            â”‚ â”‚
â”‚  â”‚  - IndicaÃ§Ã£o: Diabetes Mellitus tipo 2, IC, DRC             â”‚ â”‚
â”‚  â”‚  - Dose: 10mg 1x/dia, independente de peso                  â”‚ â”‚
â”‚  â”‚  - Ajuste renal: nÃ£o requer se TFG > 25 mL/min              â”‚ â”‚
â”‚  â”‚  """                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         STEP 5: Chamar Gemini 2.5 Pro com System Instructions   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  from vertexai.preview.generative_models import (           â”‚ â”‚
â”‚  â”‚    GenerativeModel                                           â”‚ â”‚
â”‚  â”‚  )                                                            â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  model = GenerativeModel(                                    â”‚ â”‚
â”‚  â”‚    "gemini-2.5-pro-preview-0219",                            â”‚ â”‚
â”‚  â”‚    system_instruction=MED_BRAIN_INSTRUCTIONS                 â”‚ â”‚
â”‚  â”‚  )                                                            â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  response = model.generate_content([                         â”‚ â”‚
â”‚  â”‚    f"CONTEXTO:\n{context}",                                  â”‚ â”‚
â”‚  â”‚    f"\nQUERY ({user_level}):\n{original_query}"             â”‚ â”‚
â”‚  â”‚  ])                                                           â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  # Parsear JSON da resposta                                  â”‚ â”‚
â”‚  â”‚  result = json.loads(response.text)                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚  Output (formato JSON):                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  {                                                           â”‚ â”‚
â”‚  â”‚    "response_level": "doctor",                               â”‚ â”‚
â”‚  â”‚    "content": {                                              â”‚ â”‚
â”‚  â”‚      "answer": "ğŸ’Š **Dapagliflozina em IC**\n\n            â”‚ â”‚
â”‚  â”‚        **Dose:** 10mg 1Ã— ao dia (dose Ãºnica,                â”‚ â”‚
â”‚  â”‚        independente de peso)\n\n                             â”‚ â”‚
â”‚  â”‚        **EvidÃªncia:**\n                                      â”‚ â”‚
â”‚  â”‚        - DAPA-HF (NEJM 2019): â†“ 26% mortalidade CV          â”‚ â”‚
â”‚  â”‚        - SBC 2024: RecomendaÃ§Ã£o Classe I (NÃ­vel A)          â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚        **Importante:**\n                                     â”‚ â”‚
â”‚  â”‚        âš ï¸ Verificar TFG (suspender se < 25 mL/min)          â”‚ â”‚
â”‚  â”‚        âš ï¸ Monitorar sinais de cetoacidose                   â”‚ â”‚
â”‚  â”‚        âš ï¸ Pode causar hipotensÃ£o inicial",                  â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚      "action_buttons": [                                     â”‚ â”‚
â”‚  â”‚        {                                                     â”‚ â”‚
â”‚  â”‚          "label": "Ver Bula ANVISA",                         â”‚ â”‚
â”‚  â”‚          "url": "https://consultas.anvisa.gov.br/..."       â”‚ â”‚
â”‚  â”‚        },                                                     â”‚ â”‚
â”‚  â”‚        {                                                     â”‚ â”‚
â”‚  â”‚          "label": "Diretriz SBC 2024 (PDF)",                â”‚ â”‚
â”‚  â”‚          "url": "https://abc.cardiol.br/..."                â”‚ â”‚
â”‚  â”‚        },                                                     â”‚ â”‚
â”‚  â”‚        {                                                     â”‚ â”‚
â”‚  â”‚          "label": "Estudo DAPA-HF (PubMed)",                â”‚ â”‚
â”‚  â”‚          "url": "https://pubmed.ncbi.nlm.nih.gov/31535829" â”‚ â”‚
â”‚  â”‚        }                                                      â”‚ â”‚
â”‚  â”‚      ],                                                       â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚      "sources": [                                            â”‚ â”‚
â”‚  â”‚        "PMID:31535829",                                      â”‚ â”‚
â”‚  â”‚        "SBC_2024_IC",                                        â”‚ â”‚
â”‚  â”‚        "ANVISA_Forxiga_Bula"                                 â”‚ â”‚
â”‚  â”‚      ]                                                        â”‚ â”‚
â”‚  â”‚    }                                                          â”‚ â”‚
â”‚  â”‚  }                                                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         STEP 6: Renderizar Resposta no Frontend                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  <AssistantResponse>                                         â”‚ â”‚
â”‚  â”‚    <Markdown>{result.content.answer}</Markdown>             â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚    <ActionButtons>                                           â”‚ â”‚
â”‚  â”‚      {result.content.action_buttons.map(btn =>              â”‚ â”‚
â”‚  â”‚        <Button href={btn.url}>{btn.label}</Button>          â”‚ â”‚
â”‚  â”‚      )}                                                       â”‚ â”‚
â”‚  â”‚    </ActionButtons>                                          â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚    <Sources>                                                 â”‚ â”‚
â”‚  â”‚      {result.content.sources.map(src =>                     â”‚ â”‚
â”‚  â”‚        <SourceTag>{src}</SourceTag>                          â”‚ â”‚
â”‚  â”‚      )}                                                       â”‚ â”‚
â”‚  â”‚    </Sources>                                                â”‚ â”‚
â”‚  â”‚  </AssistantResponse>                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Tempo total:** ~2-3 segundos  
**Custo:** ~$0.007/query (Gemini + embeddings)  
**Qualidade:** Zero-hallucination (todas as respostas tÃªm fontes)

---

## ğŸ”” SISTEMA DE NOTIFICAÃ‡Ã•ES

### Arquitetura Pub/Sub

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EVENT SOURCES                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Cloud Function (PubMed) â†’ Novos estudos publicados           â”‚
â”‚  2. Cloud Function (ANVISA) â†’ Alertas de seguranÃ§a crÃ­ticos      â”‚
â”‚  3. Backend (Express) â†’ Novos materiais, convites, badges        â”‚
â”‚  4. Partner API (Apigee) â†’ Updates de laboratÃ³rios               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“ publish
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PUB/SUB TOPICS                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ medfocus/new-studies                                          â”‚
â”‚  â€¢ medfocus/anvisa-alerts                                         â”‚
â”‚  â€¢ medfocus/user-notifications                                    â”‚
â”‚  â€¢ medfocus/lab-updates                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“ subscribe
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   NOTIFICATION HANDLER                            â”‚
â”‚  (Cloud Function Python ou Backend Express)                      â”‚
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  def handle_notification(message):                          â”‚  â”‚
â”‚  â”‚    data = json.loads(message.data)                          â”‚  â”‚
â”‚  â”‚                                                              â”‚  â”‚
â”‚  â”‚    # Determinar destinatÃ¡rios                               â”‚  â”‚
â”‚  â”‚    if data['type'] == 'anvisa_alert':                       â”‚  â”‚
â”‚  â”‚      # Buscar mÃ©dicos inscritos na droga X                 â”‚  â”‚
â”‚  â”‚      subscribers = db.query("""                             â”‚  â”‚
â”‚  â”‚        SELECT user_id FROM user_subscriptions               â”‚  â”‚
â”‚  â”‚        WHERE medication_id = :medication_id                 â”‚  â”‚
â”‚  â”‚      """, medication_id=data['medication_id'])              â”‚  â”‚
â”‚  â”‚    elif data['type'] == 'new_material':                     â”‚  â”‚
â”‚  â”‚      # Notificar turma inteira                              â”‚  â”‚
â”‚  â”‚      subscribers = get_classroom_members(                   â”‚  â”‚
â”‚  â”‚        data['classroom_id']                                  â”‚  â”‚
â”‚  â”‚      )                                                        â”‚  â”‚
â”‚  â”‚                                                              â”‚  â”‚
â”‚  â”‚    # Criar notificaÃ§Ã£o no banco                             â”‚  â”‚
â”‚  â”‚    for user_id in subscribers:                              â”‚  â”‚
â”‚  â”‚      db.insert_notification(                                â”‚  â”‚
â”‚  â”‚        user_id=user_id,                                      â”‚  â”‚
â”‚  â”‚        type=data['type'],                                    â”‚  â”‚
â”‚  â”‚        title=data['title'],                                  â”‚  â”‚
â”‚  â”‚        content=data['content']                               â”‚  â”‚
â”‚  â”‚      )                                                        â”‚  â”‚
â”‚  â”‚                                                              â”‚  â”‚
â”‚  â”‚      # Enviar push notification (Firebase Cloud Messaging)  â”‚  â”‚
â”‚  â”‚      send_fcm_notification(                                  â”‚  â”‚
â”‚  â”‚        user_id=user_id,                                      â”‚  â”‚
â”‚  â”‚        notification=data                                     â”‚  â”‚
â”‚  â”‚      )                                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   DELIVERY CHANNELS                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. In-app (React) â†’ Badge no sino de notificaÃ§Ãµes              â”‚
â”‚  2. Push (FCM) â†’ NotificaÃ§Ã£o mobile/desktop                      â”‚
â”‚  3. Email â†’ Para alertas crÃ­ticos (opcional)                     â”‚
â”‚  4. WebSocket â†’ NotificaÃ§Ã£o em tempo real (se usuÃ¡rio online)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” SEGURANÃ‡A E AUTENTICAÃ‡ÃƒO

### Fluxo de AutenticaÃ§Ã£o (JWT)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER (Browser)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Login Form              â”‚
                    â”‚ email: user@email.com   â”‚
                    â”‚ password: ********      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“ POST /api/trpc/auth.login
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BACKEND (tRPC)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  authRouter.login = procedure                               â”‚  â”‚
â”‚  â”‚    .input(z.object({                                         â”‚  â”‚
â”‚  â”‚      email: z.string().email(),                              â”‚  â”‚
â”‚  â”‚      password: z.string().min(8)                             â”‚  â”‚
â”‚  â”‚    }))                                                        â”‚  â”‚
â”‚  â”‚    .mutation(async ({ input }) => {                          â”‚  â”‚
â”‚  â”‚      // 1. Buscar usuÃ¡rio no DB                             â”‚  â”‚
â”‚  â”‚      const user = await db.users.findOne({                  â”‚  â”‚
â”‚  â”‚        email: input.email                                    â”‚  â”‚
â”‚  â”‚      });                                                      â”‚  â”‚
â”‚  â”‚                                                              â”‚  â”‚
â”‚  â”‚      if (!user) throw new TRPCError({                       â”‚  â”‚
â”‚  â”‚        code: 'UNAUTHORIZED',                                 â”‚  â”‚
â”‚  â”‚        message: 'Credenciais invÃ¡lidas'                     â”‚  â”‚
â”‚  â”‚      });                                                      â”‚  â”‚
â”‚  â”‚                                                              â”‚  â”‚
â”‚  â”‚      // 2. Verificar senha (bcrypt)                         â”‚  â”‚
â”‚  â”‚      const validPassword = await bcrypt.compare(            â”‚  â”‚
â”‚  â”‚        input.password,                                       â”‚  â”‚
â”‚  â”‚        user.password_hash                                    â”‚  â”‚
â”‚  â”‚      );                                                       â”‚  â”‚
â”‚  â”‚                                                              â”‚  â”‚
â”‚  â”‚      if (!validPassword) throw new TRPCError({              â”‚  â”‚
â”‚  â”‚        code: 'UNAUTHORIZED',                                 â”‚  â”‚
â”‚  â”‚        message: 'Credenciais invÃ¡lidas'                     â”‚  â”‚
â”‚  â”‚      });                                                      â”‚  â”‚
â”‚  â”‚                                                              â”‚  â”‚
â”‚  â”‚      // 3. Gerar JWT (Access + Refresh tokens)             â”‚  â”‚
â”‚  â”‚      const accessToken = jwt.sign(                           â”‚  â”‚
â”‚  â”‚        {                                                      â”‚  â”‚
â”‚  â”‚          user_id: user.id,                                   â”‚  â”‚
â”‚  â”‚          email: user.email,                                  â”‚  â”‚
â”‚  â”‚          role: user.role                                     â”‚  â”‚
â”‚  â”‚        },                                                     â”‚  â”‚
â”‚  â”‚        process.env.JWT_SECRET,                               â”‚  â”‚
â”‚  â”‚        { expiresIn: '15m' }  // 15 minutos                  â”‚  â”‚
â”‚  â”‚      );                                                       â”‚  â”‚
â”‚  â”‚                                                              â”‚  â”‚
â”‚  â”‚      const refreshToken = jwt.sign(                          â”‚  â”‚
â”‚  â”‚        { user_id: user.id },                                 â”‚  â”‚
â”‚  â”‚        process.env.JWT_REFRESH_SECRET,                       â”‚  â”‚
â”‚  â”‚        { expiresIn: '7d' }  // 7 dias                       â”‚  â”‚
â”‚  â”‚      );                                                       â”‚  â”‚
â”‚  â”‚                                                              â”‚  â”‚
â”‚  â”‚      // 4. Armazenar refresh token no DB                    â”‚  â”‚
â”‚  â”‚      await db.refresh_tokens.insert({                        â”‚  â”‚
â”‚  â”‚        user_id: user.id,                                     â”‚  â”‚
â”‚  â”‚        token: refreshToken,                                  â”‚  â”‚
â”‚  â”‚        expires_at: new Date(Date.now() + 7*24*60*60*1000)  â”‚  â”‚
â”‚  â”‚      });                                                      â”‚  â”‚
â”‚  â”‚                                                              â”‚  â”‚
â”‚  â”‚      // 5. Retornar tokens                                   â”‚  â”‚
â”‚  â”‚      return {                                                 â”‚  â”‚
â”‚  â”‚        user: {                                                â”‚  â”‚
â”‚  â”‚          id: user.id,                                         â”‚  â”‚
â”‚  â”‚          name: user.name,                                     â”‚  â”‚
â”‚  â”‚          email: user.email,                                   â”‚  â”‚
â”‚  â”‚          role: user.role                                      â”‚  â”‚
â”‚  â”‚        },                                                      â”‚  â”‚
â”‚  â”‚        accessToken,                                           â”‚  â”‚
â”‚  â”‚        refreshToken                                           â”‚  â”‚
â”‚  â”‚      };                                                        â”‚  â”‚
â”‚  â”‚    });                                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â†“ Response
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER (Browser)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  // Armazenar tokens                                         â”‚  â”‚
â”‚  â”‚  localStorage.setItem('jwt_token', response.accessToken);   â”‚  â”‚
â”‚  â”‚  localStorage.setItem('refresh_token',                       â”‚  â”‚
â”‚  â”‚                       response.refreshToken);                â”‚  â”‚
â”‚  â”‚                                                              â”‚  â”‚
â”‚  â”‚  // Redirecionar para dashboard                             â”‚  â”‚
â”‚  â”‚  navigate('/dashboard');                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Middleware de AutenticaÃ§Ã£o

```typescript
// server/middleware/auth.ts

import { TRPCError } from '@trpc/server';
import jwt from 'jsonwebtoken';

export const authMiddleware = async ({ ctx, next }) => {
  const authHeader = ctx.req.headers.authorization;
  
  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    throw new TRPCError({
      code: 'UNAUTHORIZED',
      message: 'Token nÃ£o fornecido'
    });
  }

  const token = authHeader.substring(7); // Remove "Bearer "

  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    
    // Adicionar user ao context
    ctx.user = {
      id: decoded.user_id,
      email: decoded.email,
      role: decoded.role
    };

    return next({ ctx });
  } catch (error) {
    if (error.name === 'TokenExpiredError') {
      throw new TRPCError({
        code: 'UNAUTHORIZED',
        message: 'Token expirado. Use /auth.refreshToken'
      });
    }
    
    throw new TRPCError({
      code: 'UNAUTHORIZED',
      message: 'Token invÃ¡lido'
    });
  }
};

// Uso nos routers
export const materialsRouter = router({
  create: procedure
    .use(authMiddleware) // âœ… Requer autenticaÃ§Ã£o
    .input(createMaterialSchema)
    .mutation(async ({ ctx, input }) => {
      // ctx.user estÃ¡ disponÃ­vel aqui
      const material = await db.materials.insert({
        ...input,
        author_id: ctx.user.id // User autenticado
      });
      return material;
    })
});
```

---

## ğŸ“ˆ ESCALABILIDADE E PERFORMANCE

### EstratÃ©gias de OtimizaÃ§Ã£o

#### 1. Caching (TanStack Query)

```typescript
// client/src/lib/trpc.ts

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 5 * 60 * 1000, // 5 minutos
      cacheTime: 10 * 60 * 1000, // 10 minutos
      refetchOnWindowFocus: false,
      retry: 2
    }
  }
});

// Uso:
const { data: quizzes } = trpc.quizzes.list.useQuery(
  { type: 'enamed' },
  {
    staleTime: 10 * 60 * 1000, // Override: 10 minutos
    // Dados ficam em cache por 10 min, nÃ£o faz re-fetch
  }
);
```

---

#### 2. BigQuery Partitioning & Clustering

```sql
-- Tabela particionada por data de publicaÃ§Ã£o
CREATE TABLE medfocus.pubmed_studies (
  ...
)
PARTITION BY DATE(publication_date)
CLUSTER BY molecule, therapeutic_class;

-- Query otimizada (usa partition pruning)
SELECT *
FROM medfocus.pubmed_studies
WHERE DATE(publication_date) >= '2020-01-01'  -- Partition filter
  AND molecule = 'Dapagliflozina'              -- Cluster filter
LIMIT 100;

-- Processa apenas partiÃ§Ãµes de 2020-2024 (~20% dos dados)
-- Custo: $1/TB Ã— 0.5GB processado = $0.0005 (em vez de $0.0025 full scan)
```

---

#### 3. Cloud Run Auto-scaling

```yaml
# cloudbuild.yaml (Deploy config)

gcloud run deploy medfocus-backend \
  --image gcr.io/$PROJECT_ID/backend:latest \
  --min-instances 1 \         # Sempre 1 instÃ¢ncia ativa
  --max-instances 10 \        # MÃ¡ximo 10 instÃ¢ncias
  --cpu 1 \
  --memory 512Mi \
  --concurrency 80 \          # 80 requisiÃ§Ãµes/instÃ¢ncia
  --timeout 60s \
  --set-env-vars "NODE_ENV=production"
```

**Comportamento:**
- **0-100 req/s:** 1 instÃ¢ncia (custo mÃ­nimo)
- **100-800 req/s:** 2-10 instÃ¢ncias (auto-scale)
- **> 800 req/s:** Novas requisiÃ§Ãµes aguardam em fila

**Custo:**
- 1 instÃ¢ncia 24/7: $60/mÃªs
- Picos (10 instÃ¢ncias por 1h/dia): +$20/mÃªs
- **Total:** ~$80/mÃªs

---

#### 4. CDN para Assets EstÃ¡ticos

```typescript
// vite.config.ts

export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        // Code splitting por rota
        manualChunks: {
          'vendor': ['react', 'react-dom'],
          'ui': ['@radix-ui/react-*'],
          'utils': ['@tanstack/react-query', 'trpc']
        }
      }
    }
  },
  base: process.env.VITE_CDN_URL || '/' // CDN URL
});
```

**Deploy Vercel (CDN global):**
- 100+ edge locations
- Cache automÃ¡tico (images, CSS, JS)
- Brotli compression
- HTTP/3

**Performance:**
- TTFB (Time to First Byte): < 100ms
- FCP (First Contentful Paint): < 1.5s
- LCP (Largest Contentful Paint): < 2.5s

---

## ğŸ“Š MÃ‰TRICAS E MONITORAMENTO

### Cloud Monitoring Dashboards

```yaml
# MÃ©tricas principais (GCP)

1. Backend (Cloud Run):
   - Request count (req/s)
   - Request latency (p50, p95, p99)
   - Error rate (5xx errors)
   - CPU utilization (%)
   - Memory utilization (%)
   - Instance count

2. BigQuery:
   - Query count
   - Bytes processed
   - Query execution time
   - Slot utilization

3. Vertex AI:
   - Embedding requests/s
   - Gemini requests/s
   - Token usage
   - Error rate

4. Cloud Functions:
   - Executions/day
   - Execution time (avg)
   - Errors
```

### Alertas Configurados

```yaml
# Cloud Monitoring Alerts

1. ğŸ”´ CRITICAL:
   - Backend error rate > 5% (5 min)
   - Backend latency p95 > 2s (5 min)
   - BigQuery daily cost > $50
   - Vertex AI error rate > 10%

2. ğŸŸ¡ WARNING:
   - Backend instances = max (10) por > 30 min
   - BigQuery bytes processed > 100GB/dia
   - Cloud Function timeout > 50% das execuÃ§Ãµes

3. ğŸ“Š INFO:
   - Daily active users (DAU)
   - New signups/dia
   - Quizzes completed/dia
```

---

## ğŸ“ CONCLUSÃƒO

Esta arquitetura foi projetada para:

âœ… **Escalabilidade:** Auto-scaling no Cloud Run + BigQuery massivo  
âœ… **Performance:** CDN global + caching agressivo + embeddings prÃ©-computados  
âœ… **Confiabilidade:** Health checks + auto-restart + multi-zona  
âœ… **SeguranÃ§a:** JWT + HTTPS + Helmet + rate limiting  
âœ… **Custo-eficiÃªncia:** Pay-per-use + caching + partition pruning  
âœ… **Developer Experience:** Type-safety (tRPC) + hot reload (Vite)  
âœ… **Manutenibilidade:** Monorepo + TypeScript strict + testes automatizados

**Capacidade mÃ¡xima estimada:**
- **UsuÃ¡rios simultÃ¢neos:** 10.000+
- **RequisiÃ§Ãµes/segundo:** 800+
- **Queries BigQuery/dia:** 100.000+
- **Armazenamento:** Petabytes (BigQuery)

**Tempo de resposta:**
- **API calls (tRPC):** < 100ms (p95)
- **Med-Brain (Gemini):** < 3s (p95)
- **BigQuery (RAG):** < 1s (p95)
- **Page load:** < 2s (LCP)

---

**Documento gerado automaticamente**  
**Data:** 23-Feb-2026  
**VersÃ£o:** 1.0

---

*Para dÃºvidas ou sugestÃµes, consulte o repositÃ³rio GitHub ou abra uma issue.*
